apiVersion: apps/v1
kind: Deployment
metadata:
  name: k8s-monitor
  namespace: k8s-monitor
  labels:
    app: k8s-monitor
    version: v1
spec:
  replicas: 1
  strategy:
    type: Recreate  # Single instance, no rolling updates needed

  selector:
    matchLabels:
      app: k8s-monitor

  template:
    metadata:
      labels:
        app: k8s-monitor
        version: v1
      annotations:
        prometheus.io/scrape: "false"

    spec:
      # Use service account with cluster read access
      # In-cluster: ServiceAccount tokens are automatically mounted at /var/run/secrets/kubernetes.io/serviceaccount/
      # Local/Docker: KUBECONFIG environment variable is used (via settings.py validation)
      serviceAccountName: k8s-monitor

      # Security context
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
        fsGroup: 0

      # Pull policy
      imagePullPolicy: Always

      # Containers
      containers:
        - name: k8s-monitor
          image: your-registry/k8s-monitor:latest

          # Command (use default from Dockerfile unless overriding)
          command: ["python", "-m"]
          args: ["src.main"]

          # Environment from ConfigMap
          envFrom:
            - configMapRef:
                name: k8s-monitor-config

          # Environment from Secret
          env:
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: k8s-monitor-secrets
                  key: ANTHROPIC_API_KEY

            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: k8s-monitor-secrets
                  key: GITHUB_TOKEN

            - name: SLACK_BOT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: k8s-monitor-secrets
                  key: SLACK_BOT_TOKEN

            - name: SLACK_CHANNEL
              valueFrom:
                secretKeyRef:
                  name: k8s-monitor-secrets
                  key: SLACK_CHANNEL

          # Resource limits
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 512Mi

          # Health check
          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import sys; sys.exit(0)"
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 3

          # Volume mounts
          volumeMounts:
            - name: logs
              mountPath: /app/logs
            - name: agent-definitions
              mountPath: /app/.claude/agents
              readOnly: true
            - name: orchestrator-context
              mountPath: /app/.claude
              readOnly: true

      # Restart policy
      restartPolicy: Always

      # Volumes
      volumes:
        - name: logs
          persistentVolumeClaim:
            claimName: k8s-monitor-logs  # References the PVC for persistent storage

        - name: orchestrator-context
          configMap:
            name: k8s-monitor-orchestrator
            # Maps CLAUDE.md from ConfigMap to /app/.claude/CLAUDE.md
            items:
              - key: CLAUDE.md
                path: CLAUDE.md

        - name: agent-definitions
          configMap:
            name: k8s-monitor-agents
            # Each key in the ConfigMap becomes a file in /app/.claude/agents
            # Example: k8s-analyzer.md, escalation-manager.md, etc.

      # Node selection (optional - constrain to specific nodes)
      # nodeSelector:
      #   workload: monitoring

      # Tolerations (optional - allow scheduling on tainted nodes)
      # tolerations:
      #   - key: monitoring
      #     operator: Equal
      #     value: "true"
      #     effect: NoSchedule

      # Affinity (optional - spread across nodes)
      # affinity:
      #   podAntiAffinity:
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 100
      #         podAffinityTerm:
      #           labelSelector:
      #             matchExpressions:
      #               - key: app
      #                 operator: In
      #                 values:
      #                   - k8s-monitor
      #           topologyKey: kubernetes.io/hostname
