# dev-eks-oncall-engineer-v2 - Architecture Diagram

## Visual Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Microsoft Teams Channel                          â”‚
â”‚                        "oncall-engineer" Channel                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                        User posts: "Check proteus service"
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 1: Microsoft Teams Trigger                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Type: Webhook (Graph API subscription)                                 â”‚
â”‚  Listens: New messages in oncall-engineer channel                       â”‚
â”‚                                                                          â”‚
â”‚  Output:                                                                 â”‚
â”‚  {                                                                       â”‚
â”‚    "id": "1760102547983",                                               â”‚
â”‚    "@odata.id": "teams('..')/channels('..')/messages('..')"            â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 2: get_teams_message (HTTP Request)                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Method: GET                                                             â”‚
â”‚  URL: https://graph.microsoft.com/v1.0/{{ @odata.id }}                  â”‚
â”‚  Auth: Microsoft Graph Security OAuth2                                  â”‚
â”‚                                                                          â”‚
â”‚  Purpose: Fetch full message content (text, sender, timestamp)          â”‚
â”‚                                                                          â”‚
â”‚  Output:                                                                 â”‚
â”‚  {                                                                       â”‚
â”‚    "id": "1760102547983",                                               â”‚
â”‚    "body": {                                                             â”‚
â”‚      "content": "Check proteus service"                                 â”‚
â”‚    },                                                                    â”‚
â”‚    "from": {                                                             â”‚
â”‚      "user": {"displayName": "Ari Sela"}                                â”‚
â”‚    },                                                                    â”‚
â”‚    "createdDateTime": "2025-10-10T14:29:49.862Z"                        â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 3: query_parser (Code Node)                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Logic:                                                                  â”‚
â”‚  1. Detect source (teams/webhook/cron)                                  â”‚
â”‚  2. Extract text from body.content                                      â”‚
â”‚  3. Strip HTML tags                                                      â”‚
â”‚  4. Capture user and timestamp                                          â”‚
â”‚                                                                          â”‚
â”‚  Supports:                                                               â”‚
â”‚  âœ“ Teams messages                                                        â”‚
â”‚  âœ“ Direct API calls (query/prompt fields)                               â”‚
â”‚  âœ“ Cron triggers (default query)                                        â”‚
â”‚                                                                          â”‚
â”‚  Output:                                                                 â”‚
â”‚  {                                                                       â”‚
â”‚    "query": "Check proteus service",                                    â”‚
â”‚    "source": "teams",                                                    â”‚
â”‚    "user": "Ari Sela",                                                  â”‚
â”‚    "namespace": "default",                                              â”‚
â”‚    "timestamp": "2025-10-10T14:29:49.862Z"                              â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 4: AI Agent (LangChain + Claude Sonnet 4)                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Model: claude-sonnet-4-20250514                                        â”‚
â”‚  Prompt: {{ $json.query }}                                              â”‚
â”‚  Max Iterations: 10                                                      â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  System Message: Kubernetes Operations Assistant                 â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â€¢ Service to website mappings                                   â”‚  â”‚
â”‚  â”‚  â€¢ Intelligent troubleshooting workflows                         â”‚  â”‚
â”‚  â”‚  â€¢ Severity classification rules                                 â”‚  â”‚
â”‚  â”‚  â€¢ Response formatting guidelines                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ TOOL 1:                 â”‚  â”‚ TOOL 2:                              â”‚â”‚
â”‚  â”‚ website_health_query    â”‚  â”‚ oncall_agent_query                   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ HTTP GET                â”‚  â”‚ HTTP POST                            â”‚â”‚
â”‚  â”‚ URL: <from AI>          â”‚  â”‚ URL: oncall-agent.internal...        â”‚â”‚
â”‚  â”‚                         â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ Returns:                â”‚  â”‚ Body: {"prompt": "..."}              â”‚â”‚
â”‚  â”‚ â€¢ HTTP status           â”‚  â”‚ Timeout: 120s                        â”‚â”‚
â”‚  â”‚ â€¢ Response time         â”‚  â”‚                                      â”‚â”‚
â”‚  â”‚ â€¢ Body preview          â”‚  â”‚ Returns:                             â”‚â”‚
â”‚  â”‚                         â”‚  â”‚ â€¢ Pod status & health                â”‚â”‚
â”‚  â”‚ Use: External checks    â”‚  â”‚ â€¢ K8s events & logs                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ Deployment history                 â”‚â”‚
â”‚                                â”‚ â€¢ Recommendations                    â”‚â”‚
â”‚                                â”‚                                      â”‚â”‚
â”‚                                â”‚ Use: K8s troubleshooting             â”‚â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â”‚  AI Reasoning:                                                           â”‚
â”‚  1. Understands query intent                                            â”‚
â”‚  2. Chooses appropriate tool(s)                                         â”‚
â”‚  3. Correlates findings                                                 â”‚
â”‚  4. Formats response with severity indicators                           â”‚
â”‚                                                                          â”‚
â”‚  Output:                                                                 â”‚
â”‚  {                                                                       â”‚
â”‚    "output": "âœ… **Proteus Pods - HEALTHY**\n\n5/5 pods running..."       â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 5: convert_response_teams (Code Node)                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Purpose: Transform AI output into Adaptive Card JSON                   â”‚
â”‚                                                                          â”‚
â”‚  Process:                                                                â”‚
â”‚  1. Get AI output from previous node                                    â”‚
â”‚  2. Get query metadata from query_parser                                â”‚
â”‚  3. Build Adaptive Card structure:                                      â”‚
â”‚     â€¢ Header: "ğŸ¤– On-Call Assistant"                                    â”‚
â”‚     â€¢ Body: AI markdown response                                        â”‚
â”‚     â€¢ Footer: FactSet with query/user/timestamp                         â”‚
â”‚  4. Stringify Adaptive Card content                                     â”‚
â”‚  5. Wrap in Graph API payload format                                    â”‚
â”‚                                                                          â”‚
â”‚  Output:                                                                 â”‚
â”‚  {                                                                       â”‚
â”‚    "body": {                                                             â”‚
â”‚      "contentType": "html",                                             â”‚
â”‚      "content": "<attachment id=\"1\"></attachment>"                    â”‚
â”‚    },                                                                    â”‚
â”‚    "attachments": [{                                                     â”‚
â”‚      "contentType": "application/vnd.microsoft.card.adaptive",          â”‚
â”‚      "content": "{\"type\":\"AdaptiveCard\",...}"  â† STRINGIFIED        â”‚
â”‚    }]                                                                    â”‚
â”‚  }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NODE 6: reply_teams_thread (HTTP Request)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Method: POST                                                            â”‚
â”‚  URL: https://graph.microsoft.com/v1.0/                                 â”‚
â”‚       teams/{teamId}/channels/{channelId}/messages/{messageId}/replies  â”‚
â”‚  Auth: Microsoft Graph Security OAuth2                                  â”‚
â”‚  Body: {{ $json }} â† Adaptive Card payload                              â”‚
â”‚                                                                          â”‚
â”‚  Purpose: Post formatted response as threaded reply                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Microsoft Teams Channel                          â”‚
â”‚                                                                          â”‚
â”‚  Original Message:                                                       â”‚
â”‚  ğŸ‘¤ Ari Sela: "Check proteus service"                                   â”‚
â”‚                                                                          â”‚
â”‚  â†³ Reply (Adaptive Card):                                               â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ ğŸ¤– On-Call Assistant                                            â”‚  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚    â”‚ âœ… Proteus Pods Status - HEALTHY                                â”‚  â”‚
â”‚    â”‚                                                                 â”‚  â”‚
â”‚    â”‚ Overall: 5/5 pods running with zero restarts                   â”‚  â”‚
â”‚    â”‚                                                                 â”‚  â”‚
â”‚    â”‚ Key Health Indicators:                                          â”‚  â”‚
â”‚    â”‚ âœ… All pods Ready                                               â”‚  â”‚
â”‚    â”‚ âœ… Zero Restarts                                                â”‚  â”‚
â”‚    â”‚ âœ… Distributed across 3 nodes                                   â”‚  â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚    â”‚ Query:     Check proteus service                                â”‚  â”‚
â”‚    â”‚ User:      Ari Sela                                             â”‚  â”‚
â”‚    â”‚ Timestamp: 2025-10-10T14:29:49.862Z                             â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           External Internet                               â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Microsoft Graph API (graph.microsoft.com)                       â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â€¢ Webhook subscription validation                              â”‚    â”‚
â”‚  â”‚  â€¢ Message content delivery                                     â”‚    â”‚
â”‚  â”‚  â€¢ Reply posting                                                 â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  Source IPs: 20.20.32.0/19, 20.190.128.0/18, etc.              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                       HTTPS (Port 443) â†“
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     External Webhook Ingress                              â”‚
â”‚                 n8n-dev-webhook.artemishealth.com                        â”‚
â”‚                                                                           â”‚
â”‚  â€¢ Valid SSL certificate (Let's Encrypt)                                 â”‚
â”‚  â€¢ IP Allowlist: Microsoft Graph + Power Automate IPs                   â”‚
â”‚  â€¢ Forwards to internal n8n service                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                       Internal K8s Network â†“
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Kubernetes Cluster (dev-eks)                       â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  n8n Service (n8n-dev.internal.artemishealth.com)              â”‚     â”‚
â”‚  â”‚                                                                 â”‚     â”‚
â”‚  â”‚  â€¢ Receives webhook from ingress                                â”‚     â”‚
â”‚  â”‚  â€¢ Processes workflow                                           â”‚     â”‚
â”‚  â”‚  â€¢ Makes outbound API calls                                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                           â”‚
â”‚  Outbound Connections:                                                   â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  oncall-agent.internal.artemishealth.com                        â”‚    â”‚
â”‚  â”‚                                                                  â”‚    â”‚
â”‚  â”‚  â€¢ Internal K8s monitoring API                                  â”‚    â”‚
â”‚  â”‚  â€¢ Analyzes dev-eks cluster                                     â”‚    â”‚
â”‚  â”‚  â€¢ Returns pod status, events, logs                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                       External API Calls â†“
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         External API Services                             â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Anthropic API                â”‚  â”‚  Microsoft Graph API          â”‚   â”‚
â”‚  â”‚  (api.anthropic.com)          â”‚  â”‚  (graph.microsoft.com)        â”‚   â”‚
â”‚  â”‚                               â”‚  â”‚                               â”‚   â”‚
â”‚  â”‚  â€¢ Claude Sonnet 4 inference  â”‚  â”‚  â€¢ Get message content        â”‚   â”‚
â”‚  â”‚  â€¢ Tool calling               â”‚  â”‚  â€¢ Post replies               â”‚   â”‚
â”‚  â”‚  â€¢ Response generation        â”‚  â”‚  â€¢ Adaptive Card rendering    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tool Execution Flow

```
AI Agent receives query: "Check proteus service"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Decision: This is a K8s service query            â”‚
â”‚ Tool to use: oncall_agent_query                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ oncall_agent_query Tool Execution                   â”‚
â”‚                                                      â”‚
â”‚ POST oncall-agent.internal.artemishealth.com/query  â”‚
â”‚ Body: {"prompt": "Check proteus service"}           â”‚
â”‚                                                      â”‚
â”‚ â†“ (2-8 seconds)                                     â”‚
â”‚                                                      â”‚
â”‚ Response: Markdown with pod status                  â”‚
â”‚ {                                                    â”‚
â”‚   "analysis": "âœ… 5/5 pods running...",             â”‚
â”‚   "recommendations": ["..."]                         â”‚
â”‚ }                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Agent Synthesis                                   â”‚
â”‚                                                      â”‚
â”‚ Combines tool output with reasoning                 â”‚
â”‚ Formats response with severity indicators           â”‚
â”‚ Adds context and recommendations                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
Final response formatted and sent to Teams
```

---

## Alternative Flow: Website Health Check

```
AI Agent receives: "Is devops.artemishealth.com up?"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Decision: This is a website availability query   â”‚
â”‚ Tools to use: website_health_query first            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ website_health_query Execution                       â”‚
â”‚                                                      â”‚
â”‚ GET https://devops.artemishealth.com                â”‚
â”‚                                                      â”‚
â”‚ â†“ (<1 second)                                       â”‚
â”‚                                                      â”‚
â”‚ Response: HTTP 200, 245ms                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€ IF HTTP 200 and fast: Report healthy âœ…
    â”‚
    â””â”€ IF HTTP 5xx or slow:
            â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ AI calls oncall_agent_query                 â”‚
       â”‚ Prompt: "Check backend services..."         â”‚
       â”‚                                             â”‚
       â”‚ â†“                                           â”‚
       â”‚                                             â”‚
       â”‚ Correlates website down + K8s issues        â”‚
       â”‚ Provides root cause analysis                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Azure Active Directory                         â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  App Registration: n8n-teams-integration                    â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Permissions:                                               â”‚ â”‚
â”‚  â”‚  â€¢ ChannelMessage.Read.All (delegated)                     â”‚ â”‚
â”‚  â”‚  â€¢ ChannelMessage.Send (delegated)                         â”‚ â”‚
â”‚  â”‚  â€¢ Team.ReadBasic.All (delegated)                          â”‚ â”‚
â”‚  â”‚  â€¢ offline_access (for refresh tokens)                     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Credentials:                                               â”‚ â”‚
â”‚  â”‚  â€¢ Client ID: <redacted>                                    â”‚ â”‚
â”‚  â”‚  â€¢ Client Secret: <redacted>                                â”‚ â”‚
â”‚  â”‚  â€¢ Tenant ID: 26405e3d-7860-4104-af91-84d019caf705         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â–¼                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ n8n Credential:             â”‚   â”‚ n8n Credential:              â”‚
â”‚ Microsoft Teams OAuth2      â”‚   â”‚ MS Graph Security OAuth2     â”‚
â”‚                             â”‚   â”‚                              â”‚
â”‚ Used by:                    â”‚   â”‚ Used by:                     â”‚
â”‚ â€¢ Teams Trigger             â”‚   â”‚ â€¢ get_teams_message          â”‚
â”‚                             â”‚   â”‚ â€¢ reply_teams_thread         â”‚
â”‚                             â”‚   â”‚                              â”‚
â”‚ Scopes:                     â”‚   â”‚ Scopes:                      â”‚
â”‚ â€¢ Team/Channel reading      â”‚   â”‚ â€¢ ChannelMessage.Read.All    â”‚
â”‚ â€¢ Webhook subscriptions     â”‚   â”‚ â€¢ ChannelMessage.Send        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Format at Each Stage

### Stage 1: Teams Trigger Output
```json
{
  "id": "1760102547983",
  "@odata.type": "#Microsoft.Graph.chatMessage",
  "@odata.id": "teams('7ae...')/channels('19:a32...')/messages('1760...')"
}
```

### Stage 2: get_teams_message Output
```json
{
  "id": "1760102547983",
  "messageType": "message",
  "body": {
    "content": "Check proteus service",
    "contentType": "text"
  },
  "from": {
    "user": {
      "displayName": "Ari Sela",
      "email": "ari.sela@artemishealth.com"
    }
  },
  "createdDateTime": "2025-10-10T14:29:49.862Z"
}
```

### Stage 3: query_parser Output
```json
{
  "query": "Check proteus service",
  "source": "teams",
  "user": "Ari Sela",
  "namespace": "default",
  "timestamp": "2025-10-10T14:29:49.862Z"
}
```

### Stage 4: AI Agent Output
```json
{
  "output": "âœ… **Proteus Pods Status - HEALTHY**\n\nOverall: 5/5 pods running...",
  "intermediate_steps": [
    {
      "tool": "oncall_agent_query",
      "input": "Check proteus service health...",
      "output": "..."
    }
  ]
}
```

### Stage 5: convert_response_teams Output
```json
{
  "body": {
    "contentType": "html",
    "content": "<attachment id=\"1\"></attachment>"
  },
  "attachments": [
    {
      "id": "1",
      "contentType": "application/vnd.microsoft.card.adaptive",
      "content": "{\"type\":\"AdaptiveCard\",\"version\":\"1.4\",\"body\":[...]}"
    }
  ]
}
```

### Stage 6: Teams Reply (Visual)
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘ ğŸ¤– On-Call Assistant                                 â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                      â•‘
â•‘ âœ… Proteus Pods Status - HEALTHY                     â•‘
â•‘                                                      â•‘
â•‘ Overall: 5/5 pods running with zero restarts        â•‘
â•‘                                                      â•‘
â•‘ Key Health Indicators:                              â•‘
â•‘ âœ… All pods Ready: 1/1 containers ready             â•‘
â•‘ âœ… Zero Restarts: No stability issues               â•‘
â•‘ âœ… Distributed Placement: 3 nodes                   â•‘
â•‘                                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Query:     Check proteus service                     â•‘
â•‘ User:      Ari Sela                                  â•‘
â•‘ Timestamp: 2025-10-10T14:29:49.862Z                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Error Handling & Edge Cases

### Case 1: Empty Message
```
User sends image-only message (no text)
    â†“
query_parser detects no text content
    â†“
Throws error: "No text content in Teams message"
    â†“
Workflow fails gracefully (no spam in Teams)
```

### Case 2: oncall_agent_query Timeout
```
AI calls oncall_agent_query
    â†“
Request takes >120 seconds
    â†“
HTTP Request times out
    â†“
AI Agent receives timeout error
    â†“
AI responds: "Unable to query K8s cluster (timeout)"
```

### Case 3: Website Unreachable
```
AI calls website_health_query
    â†“
GET https://down-site.com fails
    â†“
Returns HTTP error details
    â†“
AI analyzes error â†’ calls oncall_agent_query
    â†“
Provides root cause: "Site down, backend pods failing"
```

### Case 4: Multiple Tool Calls
```
User: "Check if devops.artemishealth.com is up and analyze proteus"
    â†“
AI plans: Use both tools
    â†“
Parallel execution:
  â”œâ”€ website_health_query â†’ HTTP 200, 245ms
  â””â”€ oncall_agent_query â†’ 5/5 pods healthy
    â†“
AI correlates: "Website healthy, backend healthy"
```

---

## Performance Characteristics

### Execution Metrics

| Stage | Average Time | Notes |
|-------|--------------|-------|
| Teams Trigger | <100ms | Webhook delivery |
| get_teams_message | 300-800ms | Graph API call |
| query_parser | <50ms | JavaScript processing |
| AI Agent | 3-10s | Depends on tool calls |
| â€¢ website_health_query | 200ms-2s | External website speed |
| â€¢ oncall_agent_query | 2-8s | K8s cluster analysis |
| convert_response_teams | <50ms | JSON transformation |
| reply_teams_thread | 300-800ms | Graph API call |
| **Total** | **5-15 seconds** | End-to-end latency |

### Resource Usage

**Claude API Costs**:
- Input tokens: ~500-2000 per query (system message + query)
- Output tokens: ~500-1500 per response
- Tool calls: 0-2 per query
- Estimated cost: $0.003-0.01 per interaction

**n8n Executions**:
- 1 execution per Teams message
- Typical daily volume: 10-50 executions
- Monthly cost: Negligible (self-hosted n8n)

---

## Security Model

### Principle of Least Privilege

**What the Workflow CAN Do**:
- âœ… Read Teams channel messages
- âœ… Post replies to Teams
- âœ… HTTP GET to external websites
- âœ… Query oncall-agent API (read-only K8s analysis)

**What the Workflow CANNOT Do**:
- âŒ Deploy or modify K8s resources
- âŒ Restart pods or services
- âŒ Access production clusters (dev-eks only)
- âŒ Execute arbitrary commands
- âŒ Access user credentials

### Defense in Depth

**Layer 1: Network**
- IP allowlist on webhook ingress
- Internal network isolation
- SSL/TLS for all connections

**Layer 2: Authentication**
- OAuth2 for Teams/Graph API
- API keys for Claude and oncall-agent
- No shared credentials

**Layer 3: Application**
- oncall-agent enforces cluster restrictions
- AI agent limited to read-only tools
- No destructive operations available

**Layer 4: Audit**
- All queries logged in n8n executions
- Teams conversation history preserved
- oncall-agent logs all K8s API calls

---

## Comparison: Teams Integration vs Direct API

### Before (Direct API Mode)
```
User â†’ Slack â†’ n8n webhook â†’ oncall-agent â†’ Response
```
- Manual webhook setup
- No threading
- Plain text responses
- Single tool (oncall_agent only)

### After (Teams + AI Agent)
```
User â†’ Teams â†’ Graph API â†’ n8n â†’ AI Agent â†’ Tools â†’ Adaptive Card Reply
```
- Native Teams integration
- Threaded conversations
- Rich Adaptive Card formatting
- Dual tools (website + K8s analysis)
- Intelligent tool selection

---

## Future Enhancements

### Planned Features

1. **Conversation Context**
   - Track conversation threads
   - Maintain context across messages
   - "Remember what we discussed earlier"

2. **Proactive Monitoring**
   - Scheduled health checks
   - Post alerts to Teams automatically
   - Daily/weekly status reports

3. **Interactive Actions**
   - Adaptive Card buttons: "View Logs", "Check ArgoCD"
   - Action.Submit to trigger follow-up queries
   - Quick action menu: "Scale up", "View metrics"

4. **Multi-Cluster Support**
   - Extend to staging/production (with proper safeguards)
   - Cluster selection in query
   - Cross-cluster correlation

5. **Incident Management**
   - Create Jira tickets from critical findings
   - Link to PagerDuty incidents
   - Incident correlation across services

---

## Version History

### v2.0 (2025-10-10)
- âœ… Microsoft Teams integration with webhook subscription fix
- âœ… Adaptive Card responses with rich formatting
- âœ… Threaded replies (conversation context)
- âœ… Dual tool system (website + K8s)
- âœ… Enhanced query parser (multi-source support)
- âœ… Claude Sonnet 4 upgrade
- âœ… Comprehensive error handling

### v1.0 (Previous)
- Basic Slack webhook integration
- Single tool (oncall_agent only)
- Plain text responses
- No threading

---

## Support & Maintenance

### Responsibility

**Maintained By**: ArtemisHealth DevOps Team
**Primary Contact**: Ari Sela
**SLA**: Best effort (internal tool)

### Update Schedule

**Monthly**:
- Review Microsoft Graph API IP ranges
- Update ingress allowlist if needed
- Check for n8n version updates

**Quarterly**:
- Review AI agent system message for accuracy
- Analyze usage patterns and optimize prompts
- Update service mappings for new services

**As Needed**:
- Respond to Microsoft Graph API changes
- Fix bugs reported by users
- Add new features based on feedback

### Backup & Recovery

**Workflow Backup**:
- Exported to: `docs/n8n-workflows/dev-eks-oncall-engineer-v2.json`
- Version controlled in git
- Re-importable at any time

**Credential Backup**:
- Store Client IDs, Secrets in secure password manager
- Document in team wiki (not in git!)
- Rotate credentials quarterly

---

## FAQs

### Q: Why do I need two different Microsoft credentials?

**A**: Microsoft Teams OAuth2 is for the trigger (webhook subscriptions), while Graph Security OAuth2 is for API calls (get/send messages). They use the same Azure app but different scope configurations in n8n.

---

### Q: Can I use this in other Teams channels?

**A**: Yes! Either duplicate the workflow and change the channel in the trigger, or modify the trigger to respond to all channels in the team.

---

### Q: How much does this cost to run?

**A**: Minimal:
- n8n: Self-hosted (no per-execution cost)
- Claude API: ~$0.005 per query
- Graph API: Free (within standard limits)
- Monthly total: <$5 for typical usage

---

### Q: What happens if oncall-agent is down?

**A**: The workflow fails gracefully. The AI agent receives a timeout/error from the tool and can respond with: "Unable to query K8s cluster. Please check oncall-agent service status."

---

### Q: Can the AI make changes to K8s?

**A**: No. Both tools are read-only. The AI can only analyze and recommend - it cannot deploy, restart, or modify resources.

---

### Q: How do I add a new service to monitor?

**A**: Update the AI Agent system message with the new service mapping:
```
**newservice.artemishealth.com**:
- Services: new-service
- Namespaces: new-service-dev
- Critical path: new-service only
```

The AI will automatically include it in health checks.

---

## References

- **n8n Workflow**: `dev-eks-oncall-engineer-v2.json`
- **IP Allowlist Guide**: `../n8n-integrations/IMPLEMENTATION-GUIDE.md`
- **oncall-agent API**: `../../src/integrations/orchestrator.py`
- **Claude Agent SDK**: https://github.com/anthropics/anthropic-agent-sdk
- **Microsoft Graph API**: https://learn.microsoft.com/en-us/graph/
- **Adaptive Cards**: https://adaptivecards.io/

---

**Status**: âœ… Production Ready
**Last Tested**: 2025-10-10
**Workflow ID**: lfMAty5yRDS1lIuA
